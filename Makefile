#!/usr/bin/make

CC = gcc
TARGET = mustpl
LDFLAGS = -std=gnu99 -s -static -Wall -Werror -Wl,--build-id=none
CFLAGS = -std=gnu99 -c -fPIC -Wall -Wextra -g -Os
version ?= 0.0.0-undefined

.PHONY: src/version.h $(TARGET) clean

$(TARGET): obj/libargp.a obj/libcjson.a obj/mustach-cjson.o obj/mustach-wrap.o obj/mustach.o obj/envsubst.o obj/cli.o obj/main.o
	$(CC) $(LDFLAGS) -L./obj $(wildcard obj/*.o) -o $(TARGET) -largp -lcjson
	@-file $(TARGET) # print file info

src/version.h:
	@printf '// Code generated by `make version.h`; DO NOT EDIT.\n\n#define APP_VERSION "%s"\n' "$(version)" > $@




obj/libargp.a:
	$(CC) $(CFLAGS) -o obj/argp-ba.o libs/argp/argp-ba.c
	$(CC) $(CFLAGS) -o obj/argp-eexst.o libs/argp/argp-eexst.c
	$(CC) $(CFLAGS) -o obj/argp-fmtstream.o libs/argp/argp-fmtstream.c
	$(CC) $(CFLAGS) -o obj/argp-help.o libs/argp/argp-help.c
	$(CC) $(CFLAGS) -o obj/argp-parse.o libs/argp/argp-parse.c
	$(CC) $(CFLAGS) -o obj/argp-pv.o libs/argp/argp-pv.c
	$(CC) $(CFLAGS) -o obj/argp-pvh.o libs/argp/argp-pvh.c
	ar cr obj/libargp.a obj/argp-ba.o obj/argp-eexst.o obj/argp-fmtstream.o obj/argp-help.o obj/argp-parse.o obj/argp-pv.o obj/argp-pvh.o
	rm obj/argp-ba.o obj/argp-eexst.o obj/argp-fmtstream.o obj/argp-help.o obj/argp-parse.o obj/argp-pv.o obj/argp-pvh.o


obj/libcjson.a:
	$(CC) $(CFLAGS) -o obj/cjson.o libs/cjson/cJSON.c
	ar cr obj/libcjson.a obj/cjson.o
	rm obj/cjson.o








obj/envsubst.o: src/envsubst.c
	$(CC) $(CFLAGS) -o $@ $<

obj/cli.o: src/cli.c src/version.h
	$(CC) $(CFLAGS) -o $@ $<

obj/main.o: src/main.c
	$(CC) $(CFLAGS) -o $@ $<


obj/mustach.o: libs/mustach/mustach.c
	$(CC) $(CFLAGS) -o $@ $<

obj/mustach-wrap.o: libs/mustach/mustach-wrap.c
	$(CC) $(CFLAGS) -o $@ $<

obj/mustach-cjson.o: libs/mustach/mustach-cjson.c
	$(CC) $(CFLAGS) -o $@ $<

test: ## Run tests
	@set -e; for n in $(wildcard tests/*); do \
		$(MAKE) -C $$n test clean; \
	done

clean: ## Cleaning
	-rm $(TARGET) src/version.h obj/*.o obj/*.a
